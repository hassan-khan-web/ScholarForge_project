{% extends 'layout.html' %}

{% block content %}
<div class="w-full h-full overflow-y-auto custom-scrollbar relative">
    
    <!-- 1. INPUT SECTION -->
    <main id="input-section" class="max-w-4xl mx-auto px-6 py-12 min-h-full flex flex-col justify-center transition-all duration-500 ease-in-out">
        
        <header class="text-center mb-10">
            <h1 class="text-4xl font-bold mb-3 tracking-tight text-white">
                <span class="bg-clip-text text-transparent bg-gradient-to-r from-blue-400 to-purple-400">
                    ScholarForge
                </span>
            </h1>
            <p class="text-[#565f89] text-sm">Automated Deep Research & Report Generation</p>
        </header>

        <form id="report-form" class="w-full bg-[#1f2335] border border-[rgba(122,162,247,0.1)] p-8 rounded-2xl shadow-2xl relative overflow-hidden group">
            
            <!-- Glow Effect -->
            <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-blue-500 via-purple-500 to-blue-500 opacity-50"></div>

            <div class="mb-6">
                <label for="query" class="block text-[10px] font-bold text-blue-400 uppercase tracking-wider mb-2 ml-1">Research Topic</label>
                <input type="text" id="query" name="query" 
                       class="w-full bg-[#16161e] border border-[#2f354b] text-white rounded-xl px-4 py-3.5 focus:outline-none focus:border-blue-500 transition-all placeholder-gray-600" 
                       placeholder="e.g. Impact of Quantum Computing on Cryptography" required>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
                <div class="md:col-span-2">
                    <label class="block text-[10px] font-bold text-[#565f89] uppercase tracking-wider mb-2 ml-1">Report Structure</label>
                    <div class="relative">
                        <select id="format-select" class="w-full appearance-none bg-[#16161e] border border-[#2f354b] text-white rounded-xl px-4 py-3 focus:outline-none focus:border-blue-500 cursor-pointer">
                            <option value="literature_review">Literature Review</option>
                            <option value="case_study">Case Study</option>
                            <option value="business_white_paper">Business White Paper</option>
                            <option value="technical_manual">Technical Manual</option>
                            <option value="journalistic_article">News Article</option>
                            <option value="custom">Custom Structure...</option>
                        </select>
                        <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-4 text-gray-500">
                            <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                        </div>
                    </div>
                </div>
                <div>
                    <label class="block text-[10px] font-bold text-[#565f89] uppercase tracking-wider mb-2 ml-1">Length</label>
                    <div class="relative">
                        <select id="page-select" class="w-full appearance-none bg-[#16161e] border border-[#2f354b] text-white rounded-xl px-4 py-3 focus:outline-none focus:border-blue-500 cursor-pointer">
                            <option value="7">Short (7 Pages)</option>
                            <option value="15" selected>Standard (15 Pages)</option>
                            <option value="25">Deep Dive (25 Pages)</option>
                        </select>
                        <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-4 text-gray-500">
                            <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Custom Format Area -->
            <div id="custom-format-container" class="mb-6 hidden">
                <label class="block text-[10px] font-bold text-blue-400 uppercase tracking-wider mb-2 ml-1">Define Structure</label>
                <textarea id="custom-format-input" rows="4" class="w-full bg-[#16161e] border border-[#2f354b] text-white text-xs font-mono rounded-xl px-4 py-3 focus:outline-none focus:border-blue-500 custom-scrollbar" placeholder="# 1. Introduction..."></textarea>
            </div>

            <button type="submit" id="submit-btn" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-semibold py-3.5 rounded-xl shadow-lg shadow-blue-900/30 transform transition-all duration-200 active:scale-[0.98] flex justify-center items-center gap-2">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.384-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z"></path></svg>
                Initiate Research Agent
            </button>
        </form>
    </main>

    <!-- 2. PROGRESS SECTION -->
    <div id="progress-section" class="hidden absolute inset-0 flex flex-col items-center justify-center transition-opacity duration-500 z-20 bg-[#1a1b26] overflow-hidden">
        
        <!-- Step 1 -->
        <div id="step-1" class="progress-step absolute inset-0 flex flex-col items-center justify-center transition-all duration-700 ease-in-out transform translate-y-12 opacity-0 scale-95">
            <div class="w-14 h-14 rounded-full border-[3px] border-[#2f354b] border-t-blue-500 animate-spin mb-4 shadow-lg shadow-blue-500/20"></div>
            <h2 class="text-2xl font-bold text-white mb-1">Analyzing Topic</h2>
            <p class="text-blue-300 text-sm" id="step-1-text">Searching global databases...</p>
        </div>

        <!-- Step 2 -->
        <div id="step-2" class="progress-step absolute inset-0 flex flex-col items-center justify-center transition-all duration-700 ease-in-out transform translate-y-12 opacity-0 scale-95">
            <div class="w-14 h-14 rounded-full bg-[#1f2335] border-2 border-purple-500 flex items-center justify-center mb-4 shadow-lg shadow-purple-500/20">
                <svg class="w-7 h-7 text-purple-400 animate-pulse" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" /></svg>
            </div>
            <h2 class="text-2xl font-bold text-white mb-1">Planning Report</h2>
            <p class="text-purple-300 text-sm" id="step-2-text">Synthesizing & Structuring...</p>
        </div>

        <!-- Step 3 -->
        <div id="step-3" class="progress-step absolute inset-0 flex flex-col items-center justify-center transition-all duration-700 ease-in-out transform translate-y-12 opacity-0 scale-95">
            <div class="w-14 h-14 rounded-full bg-[#1f2335] border-2 border-green-500 flex items-center justify-center mb-4 shadow-lg shadow-green-500/20">
                <svg class="w-7 h-7 text-green-400 animate-bounce" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" /></svg>
            </div>
            <h2 class="text-2xl font-bold text-white mb-1">Drafting Content</h2>
            <p class="text-green-300 text-sm" id="step-3-text">Writing detailed sections...</p>
        </div>

        <!-- Step 4 -->
        <div id="step-4" class="progress-step absolute inset-0 flex flex-col items-center justify-center transition-all duration-700 ease-in-out transform translate-y-12 opacity-0 scale-95">
            <div class="w-14 h-14 rounded-full bg-[#1f2335] border-2 border-cyan-500 flex items-center justify-center mb-4 shadow-lg shadow-cyan-500/20">
                <svg class="w-7 h-7 text-cyan-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
            </div>
            <h2 class="text-2xl font-bold text-white mb-1">Finalizing</h2>
            <p class="text-cyan-300 text-sm" id="step-4-text">Formatting document...</p>
        </div>
    </div>

    <!-- 3. RESULTS SECTION -->
    <div id="results-container" class="hidden flex-col w-full min-h-full transition-opacity duration-700 bg-[#1a1b26]">
        <div id="result-bar" class="flex flex-col sm:flex-row justify-between items-center gap-4 p-4 sticky top-0 z-40 bg-[#13141f]/90 backdrop-blur-md border-b border-[rgba(122,162,247,0.1)]">
            <div class="flex items-center gap-3">
                <div class="p-2 bg-green-500/10 rounded-lg">
                    <svg class="h-5 w-5 text-green-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                </div>
                <div>
                    <h3 class="font-medium text-sm text-white">Report Generated</h3>
                    <p class="text-xs text-[#565f89]" id="result-topic-display">Topic</p>
                </div>
            </div>
            <div class="flex gap-2">
                <button onclick="downloadFile('pdf')" class="px-4 py-2 bg-[#1f2335] hover:bg-[#2f354b] text-gray-300 text-xs font-medium rounded-lg border border-white/5 transition-colors">PDF</button>
                <button onclick="downloadFile('docx')" class="px-4 py-2 bg-[#1f2335] hover:bg-[#2f354b] text-gray-300 text-xs font-medium rounded-lg border border-white/5 transition-colors">DOCX</button>
                <button onclick="downloadFile('txt')" class="px-4 py-2 bg-[#1f2335] hover:bg-[#2f354b] text-gray-300 text-xs font-medium rounded-lg border border-white/5 transition-colors">TXT</button>
                <button onclick="downloadFile('json')" class="px-4 py-2 bg-[#1f2335] hover:bg-[#2f354b] text-gray-300 text-xs font-medium rounded-lg border border-white/5 transition-colors">JSON</button>
                <button onclick="resetView()" class="px-4 py-2 bg-indigo-600 hover:bg-indigo-500 text-white text-xs font-medium rounded-lg transition-colors shadow-lg shadow-indigo-500/20">New Report</button>
            </div>
        </div>
        
        <div class="max-w-5xl mx-auto px-6 py-8 w-full">
            <article id="report-output" class="prose prose-invert prose-sm md:prose-base max-w-none text-[#a9b1d6]">
                <!-- Content injected here -->
            </article>
        </div>
    </div>

</div>

<!-- HIDDEN DOWNLOAD FORM -->
<div class="hidden">
    <form id="download-form" action="{{ url_for('download') }}" method="POST" target="_blank">
        <input type="hidden" name="report_content" id="dl-content">
        <input type="hidden" name="topic" id="dl-topic">
        <input type="hidden" name="format" id="dl-format">
        <input type="hidden" name="chart_path" id="dl-chart-path">
    </form>
</div>

<script>
    // --- STATE ---
    let currentQuery = "";
    let currentReportContent = "";
    let currentChartPath = "";
    let intervalId;

    // --- ELEMENTS ---
    const inputSection = document.getElementById('input-section');
    const progressSection = document.getElementById('progress-section');
    const resultsContainer = document.getElementById('results-container');
    const reportOutput = document.getElementById('report-output');
    const resultTopicDisplay = document.getElementById('result-topic-display');
    const formatSelect = document.getElementById('format-select');
    const customContainer = document.getElementById('custom-format-container');
    const customInput = document.getElementById('custom-format-input');
    const queryInput = document.getElementById('query');
    const pageSelect = document.getElementById('page-select');

    // --- FORM LOGIC ---
    formatSelect.onchange = () => {
        if (formatSelect.value === 'custom') customContainer.classList.remove('hidden');
        else customContainer.classList.add('hidden');
    };

    document.getElementById('report-form').onsubmit = async (e) => {
        e.preventDefault();
        
        // 1. Gather Data
        currentQuery = queryInput.value;
        const formatKey = formatSelect.value;
        const formatContent = customInput.value;
        const pageCount = parseInt(pageSelect.value);

        // 2. Switch UI to Progress
        inputSection.classList.add('opacity-0', '-translate-x-full');
        setTimeout(() => {
            inputSection.classList.add('hidden');
            progressSection.classList.remove('hidden');
            updateProgressVisuals(1, "Starting research...");
        }, 500);

        // 3. Start Backend Task
        try {
            const res = await fetch("{{ url_for('start_report') }}", { 
                method: 'POST', 
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ 
                    query: currentQuery, 
                    format_key: formatKey, 
                    format_content: formatContent, 
                    page_count: pageCount 
                }) 
            });
            
            const data = await res.json();
            
            if(data.task_id) {
                intervalId = setInterval(() => checkStatus(data.task_id), 3000);
            } else {
                alert("Failed to start task: " + (data.error || "Unknown error"));
                resetView();
            }
        } catch(err) { 
            console.error(err);
            alert("Network error starting task");
            resetView();
        }
    };

    // --- PROGRESS LOGIC (ANIMATION FIXED) ---
    function updateProgressVisuals(activeStep, text) {
        for (let i = 1; i <= 4; i++) {
            const el = document.getElementById(`step-${i}`);
            if (!el) continue;

            // Clean classes to ensure smooth transition
            el.className = "progress-step absolute inset-0 flex flex-col items-center justify-center transition-all duration-700 ease-in-out transform";

            if (i < activeStep) {
                // Previous: Float UP and Fade Out
                el.classList.add('opacity-0', '-translate-y-12', 'scale-95', 'z-0');
            } else if (i === activeStep) {
                // Current: Center and Fade In
                el.classList.add('opacity-100', 'translate-y-0', 'scale-100', 'z-10');
                const textEl = document.getElementById(`step-${i}-text`);
                if (textEl && text) textEl.innerText = text;
            } else {
                // Next: Stay DOWN and Invisible
                el.classList.add('opacity-0', 'translate-y-12', 'scale-95', 'z-0');
            }
        }
    }

    async function checkStatus(taskId) {
        try {
            const res = await fetch(`{{ url_for('report_status', task_id='TASK_ID') }}`.replace('TASK_ID', taskId));
            const data = await res.json();

            if (data.status === 'SUCCESS') {
                clearInterval(intervalId);
                updateProgressVisuals(4, "Done!");
                
                setTimeout(() => {
                    progressSection.classList.add('hidden');
                    resultsContainer.classList.remove('hidden');
                    setTimeout(() => resultsContainer.classList.remove('opacity-0'), 100);
                    
                    showResults(data.report_content, data.chart_path);
                }, 1000);
                
            } else if (data.status === 'FAILURE') {
                clearInterval(intervalId);
                alert("Error: " + data.error);
                resetView();
                
            } else {
                // Map status steps
                let step = 1;
                if(data.message) {
                    const msg = data.message.toLowerCase();
                    if(msg.includes("step 2") || msg.includes("synthesiz")) step = 2;
                    else if(msg.includes("step 3") || msg.includes("writ") || msg.includes("visualiz")) step = 3;
                    else if(msg.includes("step 4") || msg.includes("finaliz")) step = 4;
                }
                updateProgressVisuals(step, data.message);
            }
        } catch(e) { console.error("Polling error", e); }
    }

    function resetProgressVisuals() {
        // Reset all to "below" state
        for (let i = 1; i <= 4; i++) {
            const el = document.getElementById(`step-${i}`);
            if(el) el.className = "progress-step absolute inset-0 flex flex-col items-center justify-center transition-all duration-700 ease-in-out transform opacity-0 translate-y-12 scale-95 z-0";
        }
    }

    // --- RESULT LOGIC ---
    function showResults(content, chartPath) {
        currentReportContent = content;
        currentChartPath = chartPath;
        resultTopicDisplay.innerText = currentQuery;
        
        let html = "";
        if (chartPath) { 
            const browserPath = chartPath.replace('/app/static', '/static'); 
            html += `<div class="mb-8 p-4 bg-black/20 rounded-xl border border-white/5 flex justify-center"><img src="${browserPath}" class="rounded-lg shadow-lg max-h-[400px]"></div>`; 
        }
        
        html += marked.parse(content);
        reportOutput.innerHTML = html;
        
        styleReportOutput();
    }

    function styleReportOutput() {
        reportOutput.querySelectorAll('h1').forEach(h => h.className = 'text-3xl font-bold text-blue-200 mt-8 mb-4 border-b border-white/10 pb-2');
        reportOutput.querySelectorAll('h2').forEach(h => h.className = 'text-2xl font-bold text-white mt-6 mb-3');
        reportOutput.querySelectorAll('h3').forEach(h => h.className = 'text-xl font-semibold text-white mt-4 mb-2');
        reportOutput.querySelectorAll('p').forEach(p => p.className = 'mb-4 leading-relaxed text-gray-300');
        reportOutput.querySelectorAll('ul').forEach(u => u.className = 'list-disc pl-6 mb-4 space-y-1 text-gray-300');
        reportOutput.querySelectorAll('ol').forEach(o => o.className = 'list-decimal pl-6 mb-4 space-y-1 text-gray-300');
        reportOutput.querySelectorAll('blockquote').forEach(b => b.className = 'border-l-4 border-blue-500 pl-4 py-1 italic text-gray-400 bg-white/5 rounded-r my-4');
        reportOutput.querySelectorAll('table').forEach(t => t.className = 'w-full text-left border-collapse my-6');
        reportOutput.querySelectorAll('th').forEach(t => t.className = 'border-b border-white/20 p-2 text-blue-300 font-semibold');
        reportOutput.querySelectorAll('td').forEach(t => t.className = 'border-b border-white/10 p-2 text-sm');
    }

    function resetView() {
        resultsContainer.classList.add('hidden', 'opacity-0');
        progressSection.classList.add('hidden');
        inputSection.classList.remove('hidden', 'opacity-0', '-translate-x-full');
        queryInput.value = "";
    }

    // --- DOWNLOAD ---
    window.downloadFile = function(format) {
        const dlForm = document.getElementById('download-form');
        document.getElementById('dl-content').value = currentReportContent;
        document.getElementById('dl-topic').value = currentQuery;
        document.getElementById('dl-format').value = format;
        if(currentChartPath) document.getElementById('dl-chart-path').value = currentChartPath;
        dlForm.submit();
    };
</script>
{% endblock %}